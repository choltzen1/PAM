{% extends "base.html" %}
{% block title %}Edit Promotion{{ promo.code }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/jira_modal.css') }}">
{% endblock %}

{% block content %}
  <!-- Header -->
  <header class="header">
    <div class="header-title">Edit Promotion – {{ promo.code }}</div>
    <div class="user-name">{{ user_name }}</div>
  </header>

  <div class="container wide-container">
    <div class="layout-flex">
      <!-- LEFT PANEL -->
      <div class="left-panel">
        <div class="info-box">
          <div class="info-title">General Information</div>
          <div><b>Promo Owner:</b> {{ promo.owner }}</div>
          <div><b>Bill Facing Name:</b> {{ promo.bill_facing_name }}</div>
          <div><b>Orbit ID:</b> {{ promo.orbit_id }}</div>
          <div><b>Promo Code:</b> {{ promo.code }}</div>
          <div><b>Restricted:</b> Not Dark</div>
        </div>
        <div class="info-box">
          <div class="info-title">Description</div>
          <div class="mb-sm">{{ promo.description }}</div>
          <div><b>Promo Notes:</b></div>
          <div class="pre-line">{{ promo.promo_notes }}</div>
        </div>
        <div class="info-box">
          <div class="info-title">Updates</div>
          <div><b>Promo % Discount:</b> {{ promo.discount if promo.discount is not none else '' }}</div>
          <div><b>Promo Amount:</b> {{ promo.amount if promo.amount is not none else '' }}</div>
          <div><b>DCD Web In-Cart:</b> {{ 'Y' if promo.dcd_web_cart == 'Y' else 'N' }}</div>
          <div><b>Product Type:</b> {{ promo.product_type }}</div>
          <div><b>BOGO:</b> {{ 'Yes' if promo.bogo == 'Y' else 'No' }}</div>
          <div><b>Trade-in Group ID:</b> {{ promo.trade_in_group_id }}</div>
        </div>
        {% if promo.last_changes %}
        <div class="info-box">
          <div class="info-title">Recent Changes</div>
          <div class="last-changes">
            <div style="color: #666; font-size: 0.9em;">{{ promo.last_changes }}</div>
          </div>
        </div>
        {% endif %}
        <div class="info-box">
          <div class="info-title">Version History</div>
          <div class="version-history">
            {% for entry in promo.version_history %}
              <div>{{ entry }}</div>
            {% endfor %}
          </div>
        </div>
      </div>
      <!-- RIGHT PANEL -->
      <div class="right-panel">
        <div class="tabs">
          {% for tab in ['Details','Dates & Times','Requirements','Trade','Tiers','Segmentation','Groupings','BPTCR','SQL Generation'] %}
            <a href="{{ url_for('edit_promo', promo_code=promo.code, tab=tab) }}"
               class="tab {% if tab == active_tab %}active{% endif %}">
              {{ tab }}
            </a>
          {% endfor %}
        </div>
        <form method="post" enctype="multipart/form-data">
          <input type="hidden" name="active_tab" value="{{ active_tab }}">
          {% if active_tab == 'Details' %}
            <div class="grid-form four-col">
              <label class="section-label col-span-2">Bill Facing Name</label>
              <label class="section-label col-span-2">Initiative Name</label>
              <input class="form-control col-span-2 mb-1" name="bill_facing_name" value="{{ promo.bill_facing_name }}">
              <input class="form-control col-span-2 mb-1" name="initiative_name" value="{{ promo.initiative_name or '' }}">              <label class="section-label">Promo % Discount</label>
              <label class="section-label">Promo Amount ($)</label>
              <label class="section-label">NSEIP Drop</label>
              <label class="section-label">DCD Web Cart</label>              <input class="form-control" name="discount" value="{{ promo.discount if promo.discount is not none else '' }}" type="number" min="0" step="1" placeholder="%">
              <input class="form-control" name="amount" value="{{ promo.amount if promo.amount is not none else '' }}" type="number" min="0" step="1" placeholder="$">
              <select class="form-select" name="nseip_drop">
                <option value="Y" {% if promo.nseip_drop == 'Y' %}selected{% endif %}>Yes</option>
                <option value="N" {% if promo.nseip_drop == 'N' %}selected{% endif %}>No</option>
              </select>
              <select class="form-select" name="dcd_web_cart">
                <option value="Y" {% if promo.dcd_web_cart == 'Y' %}selected{% endif %}>Yes</option>
                <option value="N" {% if promo.dcd_web_cart == 'N' %}selected{% endif %}>No</option>
              </select>              <label class="grid-full section-label">Product Type</label>
              <div class="input-group vertical-radio grid-full mb-1">
                <label class="radio-vertical">
                  B
                  <input type="radio" name="product_type" value="B" {% if promo.product_type == 'B' %}checked{% endif %}>
                </label>
                <label class="radio-vertical">
                  G
                  <input type="radio" name="product_type" value="G" {% if promo.product_type == 'G' %}checked{% endif %}>
                </label>
                <label class="radio-vertical">
                  *
                  <input type="radio" name="product_type" value="*" {% if promo.product_type == '*' %}checked{% endif %}>
                </label>
              </div>

              <label class="section-label">BOGO</label>
              <label class="section-label">Bolt Trade-In Group ID</label>
              <label class="section-label">FPD Display Promo</label>
              <label class="section-label">On Menu</label>
              <select class="form-select" name="bogo">
                <option value="Y" {% if promo.bogo == 'Y' %}selected{% endif %}>Yes</option>
                <option value="N" {% if promo.bogo == 'N' %}selected{% endif %}>No</option>
              </select>
              <input class="form-control" name="trade_in_group_id" value="{{ promo.trade_in_group_id }}">
              <select class="form-select" name="fpd_display_promo">
                <option value="Y" {% if promo.fpd_display_promo == 'Y' %}selected{% endif %}>Yes</option>
                <option value="N" {% if promo.fpd_display_promo == 'N' %}selected{% endif %}>No</option>
              </select>
              <select class="form-select" name="on_menu">
                <option value="Y" {% if promo.on_menu == 'Y' %}selected{% endif %}>Yes</option>
                <option value="N" {% if promo.on_menu == 'N' %}selected{% endif %}>No</option>
              </select>

              <label class="section-label col-span-2">Market Group</label>
              <label class="section-label col-span-2">Store Group</label>
              <input class="form-control col-span-2" name="market_group" value="*">
              <input class="form-control col-span-2" name="store_group" value="*">              <label class="grid-full section-label">SKU Link Address</label>
              <input class="form-control grid-full" name="sku_link" value="{{ promo.sku_link }}">

              <label class="grid-full section-label">Trade-In Link Address</label>
              <input class="form-control grid-full" name="tradein_link" value="{{ promo.tradein_link }}">
            </div>
            <div class="save-footer">
              <button type="submit" class="btn btn-primary">Save Details</button>
            </div>

          {% elif active_tab == 'Dates & Times' %}
            <div class="grid-form four-col">
              <label class="section-label">Promo Start Date</label>
              <label class="section-label">Promo End Date</label>
              <label class="section-label">Comm End Date</label>
              <label class="section-label">Promo Duration</label>
              <input class="form-control" name="promo_start_date" type="date" value="{{ promo.promo_start_date }}">
              <input class="form-control" name="promo_end_date" type="date" value="{{ promo.promo_end_date }}">
              <input class="form-control" name="comm_end_date" type="date" value="{{ promo.comm_end_date }}">
              <div class="input-group vertical-radio">
                <label class="radio-vertical">
                  24
                  <input type="radio" name="promo_duration" value="24" {% if promo.promo_duration == 24 %}checked{% endif %}>
                </label>
                <label class="radio-vertical">
                  30
                  <input type="radio" name="promo_duration" value="30" {% if promo.promo_duration == 30 %}checked{% endif %}>
                </label>
                <label class="radio-vertical">
                  36
                  <input type="radio" name="promo_duration" value="36" {% if promo.promo_duration == 36 %}checked{% endif %}>
                </label>
              </div>

              <label class="section-label">Delay Time</label>
              <label class="section-label">MPSS Lookback</label>
              <label class="section-label">Promo Grace</label>
              <label class="section-label">Trade-In Grace</label>
              <input class="form-control" name="delay_time" type="number" min="0" value="{{ promo.delay_time }}">
              <input class="form-control" name="mpss_lookback" value="{{ promo.mpss_lookback }}">
              <input class="form-control" name="promo_grace" value="{{ promo.promo_grace }}">
              <input class="form-control" name="trade_in_grace" value="{{ promo.trade_in_grace }}">              <label class="section-label grid-full">Application Grace Period</label>
              <div class="input-group vertical-radio grid-full">
                {% for grace in ['G11','G12','G13','G14','G15','G16','G17','NULL'] %}
                  <label class="radio-vertical">
                    {{ grace }}
                    <input type="radio" name="application_grace_period" value="{{ grace }}" {% if promo.application_grace_period == grace %}checked{% endif %}>
                  </label>
                {% endfor %}
              </div>
            </div>
            <div class="save-footer">
              <button type="submit" class="btn btn-primary">Save Dates & Times</button>
            </div>

          {% elif active_tab == 'Requirements' %}            <div class="grid-form four-col">
              <label class="section-label">Device Sales Type</label>
              <label class="section-label">Activation Type</label>
              <label class="section-label">Active Line Required</label>
              <label class="section-label">Maintain SOC</label>
              <div class="input-group vertical-radio">
                {% for type in ['J01','S01','*','NULL'] %}
                  <label class="radio-vertical">
                    {{ type }}
                    <input type="radio" name="device_sales_type" value="{{ type }}" {% if promo.device_sales_type == type %}checked{% endif %}>
                  </label>
                {% endfor %}
              </div>
              <div class="input-group vertical-radio">
                {% for type in ['AE1','E01','N01','NA1','*','NULL'] %}
                  <label class="radio-vertical">
                    {{ type }}
                    <input type="radio" name="activation_type" value="{{ type }}" {% if promo.activation_type == type %}checked{% endif %}>
                  </label>
                {% endfor %}
              </div>
              <div class="input-group vertical-radio">
                <label class="radio-vertical">
                  Y
                  <input type="radio" name="active_line_required" value="Y" {% if promo.active_line_required == 'Y' %}checked{% endif %}>
                </label>
                <label class="radio-vertical">
                  N
                  <input type="radio" name="active_line_required" value="N" {% if promo.active_line_required == 'N' %}checked{% endif %}>
                </label>
              </div>
              <div class="input-group vertical-radio">
                <label class="radio-vertical">
                  Y
                  <input type="radio" name="maintain_soc" value="Y" {% if promo.maintain_soc == 'Y' %}checked{% endif %}>
                </label>
                <label class="radio-vertical">
                  N
                  <input type="radio" name="maintain_soc" value="N" {% if promo.maintain_soc == 'N' %}checked{% endif %}>
                </label>
              </div>

              <label class="section-label">Maintain Active Line</label>
              <label class="section-label">Limit Per BAN</label>
              <label class="section-label">Minimum GSM Count</label>
              <label class="section-label">Maximum GSM Count</label>
              <div class="input-group vertical-radio">
                <label class="radio-vertical">
                  Y
                  <input type="radio" name="maintain_active_line" value="Y" {% if promo.maintain_active_line == 'Y' %}checked{% endif %}>
                </label>
                <label class="radio-vertical">
                  N
                  <input type="radio" name="maintain_active_line" value="N" {% if promo.maintain_active_line == 'N' %}checked{% endif %}>
                </label>
              </div>              <input class="form-control" name="limit_per_ban" value="{{ promo.limit_per_ban }}">
              <input class="form-control" name="min_gsm_count" value="{{ promo.min_gsm_count }}">
              <input class="form-control" name="max_gsm_count" value="{{ promo.max_gsm_count if promo.max_gsm_count is not none else '' }}">

              <label class="section-label col-span-4">Port-In Group ID</label>
              <div class="input-group vertical-radio col-span-4">
                {% for group in ['G02','G03','G04','G05','G06','G07','NULL'] %}
                  <label class="radio-vertical">
                    {{ group }}
                    <input type="radio" name="port_in_group_id" value="{{ group }}" {% if promo.port_in_group_id == group %}checked{% endif %}>
                  </label>
                {% endfor %}
              </div><label class="section-label">Operator ID</label>
              <label class="section-label">SKU Group ID</label>
              <label class="section-label">Device Status Group ID</label>
              <label class="section-label">Clawback Indicator</label>
              <input class="form-control" name="operator_id" value="{{ promo.operator_id or '16085' }}">
              <input class="form-control" name="sku_group_id" value="{{ promo.sku_group_id }}">
              <input class="form-control" name="device_status_group_id" value="{{ promo.device_status_group_id }}">
              <div class="input-group vertical-radio">
                <label class="radio-vertical">
                  Y
                  <input type="radio" name="clawback_indicator" value="Y" {% if promo.clawback_indicator == 'Y' %}checked{% endif %}>
                </label>
                <label class="radio-vertical">
                  N
                  <input type="radio" name="clawback_indicator" value="N" {% if promo.clawback_indicator == 'N' %}checked{% endif %}>
                </label>
              </div>              <label class="section-label col-span-4">Flow Indicator</label>
              <div class="input-group vertical-radio col-span-4">
                {% for indicator in ['NULL','100RDC'] %}
                  <label class="radio-vertical">
                    {{ indicator }}
                    <input type="radio" name="flow_indicator" value="{{ indicator }}" {% if promo.flow_indicator == indicator %}checked{% endif %}>
                  </label>
                {% endfor %}
              </div>
            </div>
            <div class="save-footer">
              <button type="submit" class="btn btn-primary">Save Requirements</button>
            </div>

          {% elif active_tab == 'Trade' %}
            <div class="grid-form four-col">
              <label class="section-label col-span-3">Trade-In Group ID</label>
              <label class="section-label">Broken Trade</label>
              <input class="form-control col-span-3" name="trade_in_group_id" value="{{ promo.trade_in_group_id }}">
              <div class="input-group vertical-radio">
                <label class="radio-vertical">
                  Y
                  <input type="radio" name="broken_trade" value="Y" {% if promo.broken_trade == 'Y' %}checked{% endif %}>
                </label>
                <label class="radio-vertical">
                  N
                  <input type="radio" name="broken_trade" value="N" {% if promo.broken_trade == 'N' %}checked{% endif %}>
                </label>
              </div>
            </div>

            <div class="grid-form" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.5rem;">
              <label class="section-label">Tier 1 Make Model Group</label>
              <label class="section-label">Tier 1 Amount $</label>
              <label class="section-label">Tier 1 Trade In Cond ID</label>
              <label class="section-label">Tier 1 Min FMV</label>
              <label class="section-label">Tier 1 Max FMV</label>
              <input class="form-control" name="trade_tier_1_make_model" value="{{ promo.trade_tier_1_make_model }}">
              <input class="form-control" name="trade_tier_1_amount" value="{{ promo.trade_tier_1_amount }}">
              <input class="form-control" name="trade_tier_1_cond_id" value="{{ promo.trade_tier_1_cond_id }}" title="Trade-In Condition ID - ST1 for Good Condition">
              <input class="form-control" name="trade_tier_1_min_fmv" value="{{ promo.trade_tier_1_min_fmv }}" title="Minimum Fair Market Value">
              <input class="form-control" name="trade_tier_1_max_fmv" value="{{ promo.trade_tier_1_max_fmv }}" title="Maximum Fair Market Value">

              <label class="section-label">Tier 2 Make Model Group</label>
              <label class="section-label">Tier 2 Amount $</label>
              <label class="section-label">Tier 2 Trade In Cond ID</label>
              <label class="section-label">Tier 2 Min FMV</label>
              <label class="section-label">Tier 2 Max FMV</label>
              <input class="form-control" name="trade_tier_2_make_model" value="{{ promo.trade_tier_2_make_model }}">
              <input class="form-control" name="trade_tier_2_amount" value="{{ promo.trade_tier_2_amount }}">
              <input class="form-control" name="trade_tier_2_cond_id" value="{{ promo.trade_tier_2_cond_id }}" title="Trade-In Condition ID - ST1 for Good Condition">
              <input class="form-control" name="trade_tier_2_min_fmv" value="{{ promo.trade_tier_2_min_fmv }}" title="Minimum Fair Market Value">
              <input class="form-control" name="trade_tier_2_max_fmv" value="{{ promo.trade_tier_2_max_fmv }}" title="Maximum Fair Market Value">

              <label class="section-label">Tier 3 Make Model Group</label>
              <label class="section-label">Tier 3 Amount $</label>
              <label class="section-label">Tier 3 Trade In Cond ID</label>
              <label class="section-label">Tier 3 Min FMV</label>
              <label class="section-label">Tier 3 Max FMV</label>
              <input class="form-control" name="trade_tier_3_make_model" value="{{ promo.trade_tier_3_make_model }}">
              <input class="form-control" name="trade_tier_3_amount" value="{{ promo.trade_tier_3_amount }}">
              <input class="form-control" name="trade_tier_3_cond_id" value="{{ promo.trade_tier_3_cond_id }}" title="Trade-In Condition ID - ST1 for Good Condition">
              <input class="form-control" name="trade_tier_3_min_fmv" value="{{ promo.trade_tier_3_min_fmv }}" title="Minimum Fair Market Value">
              <input class="form-control" name="trade_tier_3_max_fmv" value="{{ promo.trade_tier_3_max_fmv }}" title="Maximum Fair Market Value">

              <label class="section-label">Tier 4 Make Model Group</label>
              <label class="section-label">Tier 4 Amount $</label>
              <label class="section-label">Tier 4 Trade In Cond ID</label>
              <label class="section-label">Tier 4 Min FMV</label>
              <label class="section-label">Tier 4 Max FMV</label>
              <input class="form-control" name="trade_tier_4_make_model" value="{{ promo.trade_tier_4_make_model }}">
              <input class="form-control" name="trade_tier_4_amount" value="{{ promo.trade_tier_4_amount }}">
              <input class="form-control" name="trade_tier_4_cond_id" value="{{ promo.trade_tier_4_cond_id }}" title="Trade-In Condition ID - ST1 for Good Condition">
              <input class="form-control" name="trade_tier_4_min_fmv" value="{{ promo.trade_tier_4_min_fmv }}" title="Minimum Fair Market Value">
              <input class="form-control" name="trade_tier_4_max_fmv" value="{{ promo.trade_tier_4_max_fmv }}" title="Maximum Fair Market Value">
            </div>
            <div class="save-footer">
              <div style="display: flex; justify-content: flex-end; align-items: center; gap: 15px;">
                <button type="button" onclick="clearTradeData()" class="btn btn-outline" style="background-color: #fff; border: 1px solid #dc3545; color: #dc3545;">
                  <i class="fas fa-trash"></i> Clear Trade Data
                </button>
                <button type="submit" class="btn btn-primary">Save Trade</button>
              </div>
            </div>

          {% elif active_tab == 'Tiers' %}
            <div class="grid-form four-col">
              <label class="section-label col-span-4">Tiered Group ID</label>
              <input class="form-control col-span-4" name="tiered_group_id" value="{{ promo.tiered_group_id }}">

              <label class="section-label">Tier 1 Amount $</label>
              <label class="section-label">Tier 1 SKU Group ID</label>
              <label class="section-label col-span-2">Tier 1 Devices</label>
              <input class="form-control" name="tier_1_amount" value="{{ promo.tier_1_amount }}">
              <input class="form-control" name="tier_1_sku_group_id" value="{{ promo.tier_1_sku_group_id }}">
              <textarea class="form-control col-span-2" name="tier_1_devices" rows="2" style="resize: none; height: 60px; overflow-y: auto;">{{ promo.tier_1_devices }}</textarea>

              <label class="section-label">Tier 2 Amount $</label>
              <label class="section-label">Tier 2 SKU Group ID</label>
              <label class="section-label col-span-2">Tier 2 Devices</label>
              <input class="form-control" name="tier_2_amount" value="{{ promo.tier_2_amount }}">
              <input class="form-control" name="tier_2_sku_group_id" value="{{ promo.tier_2_sku_group_id }}">
              <textarea class="form-control col-span-2" name="tier_2_devices" rows="2">{{ promo.tier_2_devices }}</textarea>

              <label class="section-label">Tier 3 Amount $</label>
              <label class="section-label">Tier 3 SKU Group ID</label>
              <label class="section-label col-span-2">Tier 3 Devices</label>
              <input class="form-control" name="tier_3_amount" value="{{ promo.tier_3_amount }}">
              <input class="form-control" name="tier_3_sku_group_id" value="{{ promo.tier_3_sku_group_id }}">
              <textarea class="form-control col-span-2" name="tier_3_devices" rows="2">{{ promo.tier_3_devices }}</textarea>

              <label class="section-label">Tier 4 Amount $</label>
              <label class="section-label">Tier 4 SKU Group ID</label>
              <label class="section-label col-span-2">Tier 4 Devices</label>
              <input class="form-control" name="tier_4_amount" value="{{ promo.tier_4_amount }}">
              <input class="form-control" name="tier_4_sku_group_id" value="{{ promo.tier_4_sku_group_id }}">
              <textarea class="form-control col-span-2" name="tier_4_devices" rows="2">{{ promo.tier_4_devices }}</textarea>
            </div>
            <div class="save-footer">
              <div style="display: flex; justify-content: flex-end; align-items: center; gap: 15px;">
                <button type="button" onclick="clearTiersData()" class="btn btn-outline" style="background-color: #fff; border: 1px solid #dc3545; color: #dc3545;">
                  <i class="fas fa-trash"></i> Clear Tiers Data
                </button>
                <button type="submit" class="btn btn-primary">Save Tiers</button>
              </div>
            </div>

          {% elif active_tab == 'Segmentation' %}
            <div class="grid-form four-col">
              <label class="grid-full section-label">Segment Name</label>
              <input class="form-control grid-full mb-1" name="segment_name" value="{{ promo.segment_name }}">

              <label class="grid-full section-label">Sub Segment</label>
              <div class="input-group vertical-radio grid-full mb-1">
                {% for segment in ['Active Military','Family','Reserve','Retired','Promo Code'] %}
                  <label class="radio-vertical">
                    {{ segment }}
                    <input type="radio" name="sub_segment" value="{{ segment }}" {% if promo.sub_segment == segment %}checked{% endif %}>
                  </label>
                {% endfor %}
              </div>

              <label class="section-label col-span-2">Segment Group ID</label>
              <label class="section-label col-span-2">Segment Level</label>
              <input class="form-control col-span-2" name="segment_group_id" value="{{ promo.segment_group_id }}">              <div class="input-group vertical-radio col-span-2">
                {% for level in ['BAN','LINE','NA'] %}
                  <label class="radio-vertical">
                    {{ level }}
                    <input type="radio" name="segment_level" value="{{ level }}" {% if promo.segment_level == level %}checked{% endif %}>
                  </label>
                {% endfor %}
              </div>
            </div>
            <div class="save-footer">
              <div style="display: flex; justify-content: flex-end; align-items: center; gap: 15px;">
                <button type="button" onclick="clearSegmentData()" class="btn btn-outline" style="background-color: #fff; border: 1px solid #dc3545; color: #dc3545;">
                  <i class="fas fa-trash"></i> Clear Segment Data
                </button>
                <button type="submit" class="btn btn-primary">Save Segmentation</button>
              </div>
            </div>

          {% elif active_tab == 'Groupings' %}
            <div class="grid-form two-col">
              <label class="section-label center grid-full mb-2">SOC Grouping</label>
                <select class="form-select full-width" name="soc_grouping">
                  <option value="Group 1NS">Group 1NS</option>
                  <option value="Group 3">Group 3</option>
                  <option value="Group 4">Group 4</option>
                  <option value="Group 5">Group 5</option>
                  <option value="Group 6">Group 6</option>
                </select>
              <div class="details-box scrollable">
                <ul class="plain-list small-text">
                  <li class="bold mb-1">Group 1NS - GSM - Consumer & TFB</li>
                  <li class="mb-1">T-Mobile ONE rate plans</li>
                  <li class="mb-1">Magenta rate plans</li>
                  <li class="mb-1">Essentials rate plans</li>
                  <li class="mb-1">Bus/Gov Unlimited rate plans</li>
                  <li class="bold mb-1">Group 3 - MI - Consumer & TFB</li>
                  <li class="mb-1">10GB or higher Mobile Internet rate plans (limited buckets)</li>
                  <li class="mb-1">Excludes unlimited highspeed data plans</li>
                  <li class="bold mb-1">Group 4 - GSM - Consumer & TFB - excludes PlusUP & MAXUp line level upsell SOCs)</li>
                  <li class="bold mb-1">Group 5 - MI - All MTME Eligible MI/BTS - Consumer & TFB</li>
                  <li class="bold mb-1">Group 6 - GSM - Consumer & TFB</li>
                  <li class="mb-1">TMO ONE Plus rate plans (Incl. 55+)</li>
                  <li class="mb-1">Magenta Plus rate plans (Incl. First Responder & 55+)</li>
                  <li class="mb-1">Magenta MAX rate plans (Incl. First responder & 55+)</li>
                  <li class="mb-1">TMO ONE Plus Military rate plans</li>
                  <li class="mb-1">Magenta Plus Military rate plans</li>
                  <li class="mb-1">Magenta MAX Military rate plans</li>
                  <li class="mb-1">Business Unlimited Plus plans</li>
                  <li class="mb-1">Magenta Plus DHH plans</li>
                  <li class="mb-1">Magenta MAX DHH plans</li>
                  <li class="mb-1">Business Unlimited Ultimate plans</li>
                  <li class="mb-1">Plus Up Upsell SOCs (Include Intl/Global Plus SOCs)</li>
                  <li class="mb-1">MAXUp Upsell SOCs</li>
                  <li class="mb-1">Business Unlimited Upsell SOCs (Ultimate)</li>
                </ul>
              </div>
              <label class="section-label grid-full mt-1">Account Type</label>
              <div>
                <select class="form-select">
                  <option value="A01">A01</option>
                  <option value="A02">A02</option>
                  <option value="A03">A03</option>
                  <option value="A04">A04</option>
                  <option value="A05">A05</option>
                  <option value="A06">A06</option>
                  <option value="A07">A07</option>
                  <option value="A08">A08</option>
                  <option value="A09">A09</option>
                  <option value="A10">A10</option>
                </select>
              </div>
              <div class="details-box scrollable small-height">
                <ul class="plain-list">
                  <li class="mb-1">Regular (I/R); Association (I/A); GSA (I/F); Government (I/G); MCSA (I/M)</li>
                  <li class="mb-1">Corporate (B/C); Retail (B/L); MCSA (B/M); National (B/N); MCSAGE (B/O)</li>
                  <li class="mb-1">Non-Profit (B/P); Sole-Proprietorship (I/S)</li>
                  <li class="mb-1">Employee (S/Y); Non TMO Employee (S/6)</li>
                </ul>
              </div>
              <label class="section-label grid-full mt-1">Sales Applications</label>
              <div>
                <select class="form-select">
                  <option value="S01">S01</option>
                  <option value="S02">S02</option>
                  <option value="S03">S03</option>
                  <option value="S04">S04</option>
                  <option value="S05">S05</option>
                  <option value="S06">S06</option>
                  <option value="S07">S07</option>
                  <option value="S08">S08</option>
                  <option value="S09">S09</option>
                  <option value="S10">S10</option>
                </select>
              </div>
              <div class="details-box scrollable small-height">                <ul class="plain-list">
                  <li class="mb-1">Care - QVXPC; Dash (TSL) - Virtual Retail</li>
                  <li class="mb-1">QVXPR - Retail; POS - Retail; NAT - National Retail</li>
                  <li class="mb-1">Web (TMO) - T-Mo.com; Web - MyT-Mo (cloud)</li>
                  <li class="mb-1">Costco with EIP; BestBuy</li>
                </ul>
              </div>
            </div>
            <div class="save-footer">
              <button type="submit" class="btn btn-primary">Save Groupings</button>            </div>          {% elif active_tab == 'BPTCR' %}
            <div class="grid-form four-col">
              <label class="grid-full section-label">BPTCR</label>
              <input class="form-control grid-full mb-1" name="bptcr" value="{{ promo.bptcr or '' }}">
            </div>
            
            <!-- JIRA Ticket Management Card -->
            <div class="jira-management-card">
              <h3 class="jira-card-title">Jira Ticket Management</h3>
              
              <div class="jira-card-content">
                <div class="jira-card-info">
                  <h4>Generate BPTCR Jira Ticket</h4>
                  <p>Create a new Jira ticket for BPTCR approval process</p>
                </div>
                <button type="button" onclick="openJiraModal()" class="jira-generate-btn">
                  <i class="fas fa-ticket-alt"></i>
                  Generate Jira Ticket
                </button>
              </div>
              
              {% if promo.jira_ticket %}
              <div class="jira-ticket-status">
                <i class="fas fa-check-circle"></i>
                <strong>JIRA Ticket Created:</strong> 
                <a href="https://t-mobile-stage.atlassian.net/browse/{{ promo.jira_ticket }}" target="_blank">{{ promo.jira_ticket }}</a>
              </div>
              {% endif %}
            </div>
            
            <div class="save-footer">
              <button type="submit" class="btn btn-primary">Save BPTCR</button>            </div>          {% elif active_tab == 'SQL Generation' %}
            <div class="grid-form two-col">
              <!-- SKU List Section -->
              <div class="col-span-1">
                <div class="upload-section">
                  <label class="section-label">SKU List (Excel)</label>
                  {% if promo.uploaded_files and promo.uploaded_files.get('sku_excel') %}
                    <div class="file-info-card">
                      <div class="file-info">
                        <i class="fas fa-file-excel"></i>
                        <div class="file-details">
                          <div class="file-name">{{ promo.uploaded_files.sku_excel.original_name }}</div>
                          <div class="file-meta">
                            {{ (promo.uploaded_files.sku_excel.file_size / 1024) | round(1) }} KB • 
                            {{ promo.uploaded_files.sku_excel.upload_date[:10] }}
                          </div>
                        </div>
                      </div>
                      <div class="file-actions">
                        <a href="{{ url_for('download_file', promo_code=promo.code, file_type='sku_excel') }}" 
                           class="btn btn-sm btn-outline">Download</a>
                      </div>
                    </div>
                  {% else %}
                    <div class="upload-area">
                      <input class="form-control" type="file" name="sku_excel" accept=".xlsx,.xls">
                      <small class="form-text">Upload Excel file with SKU list</small>
                    </div>
                  {% endif %}
                </div>
              </div>
                <!-- Trade-In List Section -->
              <div class="col-span-1">
                <div class="upload-section">
                  <label class="section-label">Trade-In List (Excel)</label>
                  {% if promo.uploaded_files and promo.uploaded_files.get('tradein_excel') %}
                    <div class="file-info-card">
                      <div class="file-info">
                        <i class="fas fa-file-excel"></i>
                        <div class="file-details">
                          <div class="file-name">{{ promo.uploaded_files.tradein_excel.original_name }}</div>
                          <div class="file-meta">
                            {{ (promo.uploaded_files.tradein_excel.file_size / 1024) | round(1) }} KB • 
                            {{ promo.uploaded_files.tradein_excel.upload_date[:10] }}
                          </div>
                        </div>
                      </div>
                      <div class="file-actions">
                        <a href="{{ url_for('download_file', promo_code=promo.code, file_type='tradein_excel') }}" 
                           class="btn btn-sm btn-outline">Download</a>
                      </div>
                    </div>
                  {% else %}
                    <div class="upload-area">
                      <input class="form-control" type="file" name="tradein_excel" accept=".xlsx,.xls">
                      <small class="form-text">Upload Excel file with trade-in list</small>
                    </div>
                  {% endif %}
                </div>
              </div>
            </div>
              <!-- Display Generated SQL -->
            {% if promo.generated_sql %}
            <div class="grid-form one-col" style="margin-top: 2rem;">
              <label class="section-label">Generated SQL Statement</label>
              <div class="file-info-card" style="margin-bottom: 1rem;">
                <div class="file-info">
                  <i class="fas fa-database"></i>
                  <div>
                    <div class="file-name">{{ promo.sql_file.filename if promo.sql_file else promo.code + '_promo_eligibility_rules.sql' }}</div>
                    <div class="file-meta">
                      Generated on {{ promo.sql_file.generated_at if promo.sql_file else 'Unknown' }}
                    </div>
                  </div>
                </div>
                <div class="file-actions">
                  <a href="{{ url_for('download_sql', promo_code=promo.code) }}" 
                     class="btn btn-sm btn-outline">
                    <i class="fas fa-download"></i> Download SQL
                  </a>
                </div>
              </div>
              <textarea class="form-control" rows="25" readonly style="font-family: monospace; font-size: 12px; background-color: #f8f9fa; resize: none; overflow-y: auto;">{{ promo.generated_sql }}</textarea>
              <small class="form-text">SQL file has been generated and saved. Use the download button above to get the file.</small>
            </div>
            {% endif %}
            
            <div class="save-footer">
              <button type="submit" class="btn btn-primary">Save SQL Generation</button>
              <button type="submit" name="generate_sql" value="1" class="btn btn-secondary" style="margin-left:1em;">
                <i class="fas fa-cog"></i> Generate SQL
              </button>
            </div>
          {% endif %}

        </form>
      </div>
    </div>
  </div>

<!-- JIRA Creation Modal -->
<div id="jiraModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Create JIRA Ticket</h3>
      <span class="close" onclick="closeJiraModal()">&times;</span>
    </div>
    
    <form id="jiraForm">
      <div class="form-group">
        <label>Summary:</label>
        <input type="text" id="jiraSummary" class="form-control" placeholder="Brief description of the task" required>
      </div>
      
      <div class="form-group">
        <label>Description:</label>
        <textarea id="jiraDescription" class="form-control" rows="4" placeholder="Detailed description..." required></textarea>
      </div>
      
      <div class="form-group">
        <label>Priority:</label>
        <select id="jiraPriority" class="form-select">
          <option value="High" selected>High</option>
          <option value="Medium">Medium</option>
          <option value="Low">Low</option>
          <option value="Highest">Highest</option>
          <option value="Lowest">Lowest</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>Issue Type:</label>
        <select id="jiraIssueType" class="form-select">
          <option value="Task">Task</option>
          <option value="Bug">Bug</option>
          <option value="Story">Story</option>
          <option value="Epic">Epic</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>Parent (optional):</label>
        <select id="jiraParent" class="form-select">
          <option value="">None</option>
          <option value="CPO-2">CPO-2 - Device</option>
          <option value="CPO-3">CPO-3 - Service</option>
          <option value="DCOMM-13037">DCD-Request</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>Your JIRA Email:</label>
        <input type="email" id="jiraEmail" class="form-control" placeholder="your.email@t-mobile.com" required>
      </div>
      
      <div class="form-group">
        <label>API Token:</label>
        <input type="password" id="jiraToken" class="form-control" placeholder="Your JIRA API token" required>
        <small>Get your API token from <a href="https://id.atlassian.com/manage-profile/security/api-tokens" target="_blank">Atlassian Account Settings</a></small>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeJiraModal()">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="createJiraTicket()">
          <i class="fas fa-ticket-alt"></i> Create Ticket
        </button>
      </div>
    </form>
  </div>
</div>

{% block extra_js %}
<script src="{{ url_for('static', filename='js/jira_modal.js') }}"></script>
<script>
// Initialize promo data for JavaScript access
function initPromoData() {
  window.promoData = {
    code: "{{ promo.code }}",
    orbit_id: "{{ promo.orbit_id }}",
    initiative_name: {{ (promo.initiative_name or '') | tojson }},
    promo_start_date: "{{ promo.promo_start_date }}"
  };
}

// Call initialization when page loads
document.addEventListener('DOMContentLoaded', initPromoData);

// Trade validation functions
function validateTradeFields() {
  const brokenTradeY = document.querySelector('input[name="broken_trade"][value="Y"]');
  const brokenTradeChecked = brokenTradeY && brokenTradeY.checked;
  
  // Clear existing validation errors first
  document.querySelectorAll('.validation-error').forEach(el => {
    el.classList.remove('validation-error');
  });
  document.querySelectorAll('.validation-message').forEach(el => {
    el.remove();
  });
  
  if (brokenTradeChecked) {
    let hasErrors = false;
    // Check all trade tier condition IDs
    for (let tier = 1; tier <= 4; tier++) {
      const condInput = document.querySelector(`input[name="trade_tier_${tier}_cond_id"]`);
      if (condInput && condInput.value === 'ST1') {
        // Add error styling
        condInput.classList.add('validation-error');
        
        // Add error message
        const errorMsg = document.createElement('small');
        errorMsg.className = 'validation-message';
        errorMsg.textContent = 'Must be BT1 when Broken Trade is Yes';
        condInput.parentNode.appendChild(errorMsg);
        
        hasErrors = true;
      }
    }
    
    if (hasErrors) {
      // Show alert at top of Trade tab
      showValidationAlert('When Broken Trade is Yes, all Trade In Condition IDs must be BT1, not ST1.');
    }
  }
}

function showCompatibilityWarning(tabType, message) {
  const tabSelector = tabType === 'trade' ? 
    'div[style*="grid-template-columns: repeat(5, 1fr)"]' : 
    '.grid-form.four-col';
  
  const targetElement = document.querySelector(tabSelector);
  if (targetElement) {
    const warning = document.createElement('div');
    warning.className = 'compatibility-warning';
    warning.style.cssText = 'background-color: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 10px; margin-bottom: 15px; border-radius: 4px; font-size: 14px;';
    warning.innerHTML = `<strong>⚠️ Configuration Conflict:</strong> ${message}`;
    targetElement.insertBefore(warning, targetElement.firstChild);
  }
  
  // Add warning indicators to tab navigation
  updateTabWarnings(hasTradeData, hasTieredData);
}

function updateTabWarnings(hasTradeData, hasTieredData) {
  // Remove existing warning indicators
  document.querySelectorAll('.tab-warning').forEach(el => el.remove());
  
  if (hasTradeData && hasTieredData) {
    // Add warning to Trade tab
    const tradeTab = document.querySelector('a[href*="tab=Trade"]');
    if (tradeTab) {
      const warning = document.createElement('span');
      warning.className = 'tab-warning';
      warning.innerHTML = ' ⚠️';
      warning.style.color = '#856404';
      tradeTab.appendChild(warning);
    }
    
    // Add warning to Tiers tab
    const tiersTab = document.querySelector('a[href*="tab=Tiers"]');
    if (tiersTab) {
      const warning = document.createElement('span');
      warning.className = 'tab-warning';
      warning.innerHTML = ' ⚠️';
      warning.style.color = '#856404';
      tiersTab.appendChild(warning);
    }
  }
}

// Update the checkTierCompatibility function to track the data state
function checkTierCompatibility() {
  // Check if trade tiers have data
  let hasTradeData = false;
  for (let tier = 1; tier <= 4; tier++) {
    const amount = document.querySelector(`input[name="trade_tier_${tier}_amount"]`);
    const model = document.querySelector(`input[name="trade_tier_${tier}_make_model"]`);
    if ((amount && amount.value.trim()) || (model && model.value.trim())) {
      hasTradeData = true;
      break;
    }
  }
  
  // Check if tiered groups have data
  let hasTieredData = false;
  const tieredGroupId = document.querySelector('input[name="tiered_group_id"]');
  for (let tier = 1; tier <= 4; tier++) {
    const amount = document.querySelector(`input[name="tier_${tier}_amount"]`);
    const skuGroup = document.querySelector(`input[name="tier_${tier}_sku_group_id"]`);
    if ((amount && amount.value.trim()) || (skuGroup && skuGroup.value.trim()) || (tieredGroupId && tieredGroupId.value.trim())) {
      hasTieredData = true;
      break;
    }
  }
  
  // Store the state for use in other functions
  window.hasTradeData = hasTradeData;
  window.hasTieredData = hasTieredData;
  
  // Clear existing compatibility warnings
  document.querySelectorAll('.compatibility-warning').forEach(el => {
    el.remove();
  });
  
  // Update tab warnings
  updateTabWarnings(hasTradeData, hasTieredData);
  
  // If both have data, show warnings
  if (hasTradeData && hasTieredData) {
    showCompatibilityWarning('trade', 'Trade-in tiers and tiered groups cannot be used together. Please clear one of the configurations before proceeding.');
    showCompatibilityWarning('tiers', 'Trade-in tiers and tiered groups cannot be used together. Please clear one of the configurations before proceeding.');
  }
}

function showValidationAlert(message) {
  // Remove existing alert if any
  const existingAlert = document.querySelector('.alert-validation');
  if (existingAlert) {
    existingAlert.remove();
  }
  
  // Create new alert
  const alert = document.createElement('div');
  alert.className = 'alert-validation';
  alert.innerHTML = `<strong>Validation Error:</strong> ${message}`;
  
  // Insert at top of the active tab content
  const activeTabContent = document.querySelector('.tab-content');
  if (activeTabContent) {
    activeTabContent.insertBefore(alert, activeTabContent.firstChild);
  }
}

// Clear data functions for each tab
function clearTradeData() {
  // Send request to backend to clear trade data
  fetch(`/clear_trade_data/${window.promoData.code}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Clear the form fields in the UI
      const tradeGroupInput = document.querySelector('input[name="trade_in_group_id"]');
      if (tradeGroupInput) tradeGroupInput.value = '';
      
      // Clear broken trade radio buttons
      document.querySelectorAll('input[name="broken_trade"]').forEach(radio => {
        radio.checked = false;
      });
      
      // Clear all trade tier fields
      for (let tier = 1; tier <= 4; tier++) {
        const fields = [
          `trade_tier_${tier}_make_model`,
          `trade_tier_${tier}_amount`,
          `trade_tier_${tier}_cond_id`,
          `trade_tier_${tier}_min_fmv`,
          `trade_tier_${tier}_max_fmv`
        ];
        
        fields.forEach(fieldName => {
          const input = document.querySelector(`input[name="${fieldName}"]`);
          if (input) input.value = '';
        });
      }
      
      // Re-run validation after clearing
      validateTradeFields();
      checkTierCompatibility();
      
      // Show success message
      alert('Trade data cleared successfully!');
    } else {
      alert('Error clearing trade data: ' + data.error);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Error clearing trade data. Please try again.');
  });
}

function clearTiersData() {
  // Send request to backend to clear tiers data
  fetch(`/clear_tiers_data/${window.promoData.code}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Clear the form fields in the UI
      const tieredGroupInput = document.querySelector('input[name="tiered_group_id"]');
      if (tieredGroupInput) tieredGroupInput.value = '';
      
      // Clear all tier fields
      for (let tier = 1; tier <= 4; tier++) {
        const amountInput = document.querySelector(`input[name="tier_${tier}_amount"]`);
        const skuGroupInput = document.querySelector(`input[name="tier_${tier}_sku_group_id"]`);
        const devicesTextarea = document.querySelector(`textarea[name="tier_${tier}_devices"]`);
        
        if (amountInput) amountInput.value = '';
        if (skuGroupInput) skuGroupInput.value = '';
        if (devicesTextarea) devicesTextarea.value = '';
      }
      
      // Re-run validation after clearing
      checkTierCompatibility();
      
      // Show success message
      alert('Tiers data cleared successfully!');
    } else {
      alert('Error clearing tiers data: ' + data.error);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Error clearing tiers data. Please try again.');
  });
}

function clearSegmentData() {
  // Send request to backend to clear segment data
  fetch(`/clear_segment_data/${window.promoData.code}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Clear the form fields in the UI
      const segmentNameInput = document.querySelector('input[name="segment_name"]');
      if (segmentNameInput) segmentNameInput.value = '';
      
      // Clear sub segment radio buttons
      document.querySelectorAll('input[name="sub_segment"]').forEach(radio => {
        radio.checked = false;
      });
      
      // Clear segment group ID
      const segmentGroupInput = document.querySelector('input[name="segment_group_id"]');
      if (segmentGroupInput) segmentGroupInput.value = '';
      
      // Clear segment level radio buttons
      document.querySelectorAll('input[name="segment_level"]').forEach(radio => {
        radio.checked = false;
      });
      
      // Show success message
      alert('Segmentation data cleared successfully!');
    } else {
      alert('Error clearing segmentation data: ' + data.error);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Error clearing segmentation data. Please try again.');
  });
}

// Add event listeners when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
  // Listen for changes to broken trade radio buttons
  document.querySelectorAll('input[name="broken_trade"]').forEach(radio => {
    radio.addEventListener('change', validateTradeFields);
  });
  
  // Listen for changes to condition ID inputs
  for (let tier = 1; tier <= 4; tier++) {
    const condInput = document.querySelector(`input[name="trade_tier_${tier}_cond_id"]`);
    if (condInput) {
      condInput.addEventListener('input', validateTradeFields);
      condInput.addEventListener('blur', validateTradeFields);
    }
  }
  
  // Add tier compatibility validation listeners
  // Trade tier inputs
  for (let tier = 1; tier <= 4; tier++) {
    const amountInput = document.querySelector(`input[name="trade_tier_${tier}_amount"]`);
    const modelInput = document.querySelector(`input[name="trade_tier_${tier}_make_model"]`);
    if (amountInput) {
      amountInput.addEventListener('input', checkTierCompatibility);
      amountInput.addEventListener('blur', checkTierCompatibility);
    }
    if (modelInput) {
      modelInput.addEventListener('input', checkTierCompatibility);
      modelInput.addEventListener('blur', checkTierCompatibility);
    }
  }
  
  // Tiered group inputs
  const tieredGroupIdInput = document.querySelector('input[name="tiered_group_id"]');
  if (tieredGroupIdInput) {
    tieredGroupIdInput.addEventListener('input', checkTierCompatibility);
    tieredGroupIdInput.addEventListener('blur', checkTierCompatibility);
  }
  
  for (let tier = 1; tier <= 4; tier++) {
    const tierAmountInput = document.querySelector(`input[name="tier_${tier}_amount"]`);
    const tierSkuInput = document.querySelector(`input[name="tier_${tier}_sku_group_id"]`);
    if (tierAmountInput) {
      tierAmountInput.addEventListener('input', checkTierCompatibility);
      tierAmountInput.addEventListener('blur', checkTierCompatibility);
    }
    if (tierSkuInput) {
      tierSkuInput.addEventListener('input', checkTierCompatibility);
      tierSkuInput.addEventListener('blur', checkTierCompatibility);
    }
  }
  
  // Validate on page load
  validateTradeFields();
  checkTierCompatibility();
});
</script>
{% endblock %}
{% endblock %}
