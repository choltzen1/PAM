{% extends "base.html" %}
{% block title %}Edit Promotion{{ promo.code }}{% endblock %}
{% block content %}
  <!-- Header -->
  <header class="header">
    <div class="header-title">Edit Promotion – {{ promo.code }}</div>
    <div class="user-name">{{ user_name }}</div>
  </header>

  <div class="container wide-container">
    <div class="layout-flex">
      <!-- LEFT PANEL -->
      <div class="left-panel">
        <div class="info-box">
          <div class="info-title">General Information</div>
          <div><b>Promo Owner:</b> {{ promo.owner }}</div>
          <div><b>Bill Facing Name:</b> {{ promo.bill_facing_name }}</div>
          <div><b>Orbit ID:</b> {{ promo.orbit_id }}</div>
          <div><b>Promo Code:</b> {{ promo.code }}</div>
          <div><b>Restricted:</b> Not Dark</div>
        </div>
        <div class="info-box">
          <div class="info-title">Description</div>
          <div class="mb-sm">{{ promo.description }}</div>
          <div><b>Promo Notes:</b></div>
          <div class="pre-line">{{ promo.promo_notes }}</div>
        </div>
        <div class="info-box">
          <div class="info-title">Updates</div>
          <div><b>Promo % Discount:</b> {{ promo.discount if promo.discount is not none else '' }}</div>
          <div><b>Promo Amount:</b> {{ promo.amount if promo.amount is not none else '' }}</div>
          <div><b>DCD Web In-Cart:</b> {{ 'Y' if promo.dcd_web_cart == 'Y' else 'N' }}</div>
          <div><b>Product Type:</b> {{ promo.product_type }}</div>
          <div><b>BOGO:</b> {{ 'Yes' if promo.bogo == 'Y' else 'No' }}</div>
          <div><b>Trade-in Group ID:</b> {{ promo.trade_in_group_id }}</div>
        </div>
        {% if promo.last_changes %}
        <div class="info-box">
          <div class="info-title">Recent Changes</div>
          <div class="last-changes">
            <div style="color: #666; font-size: 0.9em;">{{ promo.last_changes }}</div>
          </div>
        </div>
        {% endif %}
        <div class="info-box">
          <div class="info-title">Version History</div>
          <div class="version-history">
            {% for entry in promo.version_history %}
              <div>{{ entry }}</div>
            {% endfor %}
          </div>
        </div>
      </div>
      <!-- RIGHT PANEL -->
      <div class="right-panel">
        <div class="tabs">
          {% for tab in ['Details','Dates & Times','Requirements','Segmentation','Groupings','BPTCR','SQL Generation'] %}
            <a href="{{ url_for('edit_promo', promo_code=promo.code, tab=tab) }}"
               class="tab {% if tab == active_tab %}active{% endif %}">
              {{ tab }}
            </a>
          {% endfor %}
        </div>
        <form method="post" enctype="multipart/form-data">
          <input type="hidden" name="active_tab" value="{{ active_tab }}">
          {% if active_tab == 'Details' %}
            <div class="grid-form four-col">
              <label class="grid-full section-label">Bill Facing Name</label>
              <input class="form-control grid-full mb-1" name="bill_facing_name" value="{{ promo.bill_facing_name }}">              <label class="section-label">Promo % Discount</label>
              <label class="section-label">Promo Amount ($)</label>
              <label class="section-label">NSEIP Drop</label>
              <label class="section-label">DCD Web Cart</label>              <input class="form-control" name="discount" value="{{ promo.discount if promo.discount is not none else '' }}" type="number" min="0" step="1" placeholder="%">
              <input class="form-control" name="amount" value="{{ promo.amount if promo.amount is not none else '' }}" type="number" min="0" step="1" placeholder="$">
              <select class="form-select" name="nseip_drop">
                <option value="Y" {% if promo.nseip_drop == 'Y' %}selected{% endif %}>Yes</option>
                <option value="N" {% if promo.nseip_drop == 'N' %}selected{% endif %}>No</option>
              </select>
              <select class="form-select" name="dcd_web_cart">
                <option value="Y" {% if promo.dcd_web_cart == 'Y' %}selected{% endif %}>Yes</option>
                <option value="N" {% if promo.dcd_web_cart == 'N' %}selected{% endif %}>No</option>
              </select>              <label class="grid-full section-label">Product Type</label>
              <div class="input-group vertical-radio grid-full mb-1">
                <label class="radio-vertical">
                  B
                  <input type="radio" name="product_type" value="B" {% if promo.product_type == 'B' %}checked{% endif %}>
                </label>
                <label class="radio-vertical">
                  G
                  <input type="radio" name="product_type" value="G" {% if promo.product_type == 'G' %}checked{% endif %}>
                </label>
                <label class="radio-vertical">
                  *
                  <input type="radio" name="product_type" value="*" {% if promo.product_type == '*' %}checked{% endif %}>
                </label>
              </div>

              <label class="section-label">BOGO</label>
              <label class="section-label">Bolt Trade-In Group ID</label>
              <label class="section-label">FPD Display Promo</label>
              <label class="section-label">On Menu</label>
              <select class="form-select" name="bogo">
                <option value="Y" {% if promo.bogo == 'Y' %}selected{% endif %}>Yes</option>
                <option value="N" {% if promo.bogo == 'N' %}selected{% endif %}>No</option>
              </select>
              <input class="form-control" name="trade_in_group_id" value="{{ promo.trade_in_group_id }}">
              <select class="form-select" name="fpd_display_promo">
                <option value="Y" {% if promo.fpd_display_promo == 'Y' %}selected{% endif %}>Yes</option>
                <option value="N" {% if promo.fpd_display_promo == 'N' %}selected{% endif %}>No</option>
              </select>
              <select class="form-select" name="on_menu">
                <option value="Y" {% if promo.on_menu == 'Y' %}selected{% endif %}>Yes</option>
                <option value="N" {% if promo.on_menu == 'N' %}selected{% endif %}>No</option>
              </select>

              <label class="section-label col-span-2">Market Group</label>
              <label class="section-label col-span-2">Store Group</label>
              <input class="form-control col-span-2" name="market_group" value="*">
              <input class="form-control col-span-2" name="store_group" value="*">              <label class="grid-full section-label">SKU Link Address</label>
              <input class="form-control grid-full" name="sku_link" value="{{ promo.sku_link }}">

              <label class="grid-full section-label">Trade-In Link Address</label>
              <input class="form-control grid-full" name="tradein_link" value="{{ promo.tradein_link }}">
            </div>
            <div class="save-footer">
              <button type="submit" class="btn btn-primary">Save Details</button>
            </div>

          {% elif active_tab == 'Dates & Times' %}
            <div class="grid-form four-col">
              <label class="section-label">Promo Start Date</label>
              <label class="section-label">Promo End Date</label>
              <label class="section-label">Comm End Date</label>
              <label class="section-label">Promo Duration</label>
              <input class="form-control" name="promo_start_date" type="date" value="{{ promo.promo_start_date }}">
              <input class="form-control" name="promo_end_date" type="date" value="{{ promo.promo_end_date }}">
              <input class="form-control" name="comm_end_date" type="date" value="{{ promo.comm_end_date }}">
              <div class="input-group vertical-radio">
                <label class="radio-vertical">
                  24
                  <input type="radio" name="promo_duration" value="24" {% if promo.promo_duration == 24 %}checked{% endif %}>
                </label>
                <label class="radio-vertical">
                  30
                  <input type="radio" name="promo_duration" value="30" {% if promo.promo_duration == 30 %}checked{% endif %}>
                </label>
                <label class="radio-vertical">
                  36
                  <input type="radio" name="promo_duration" value="36" {% if promo.promo_duration == 36 %}checked{% endif %}>
                </label>
              </div>

              <label class="section-label">Delay Time</label>
              <label class="section-label">MPSS Lookback</label>
              <label class="section-label">Promo Grace</label>
              <label class="section-label">Trade-In Grace</label>
              <input class="form-control" name="delay_time" type="number" min="0" value="{{ promo.delay_time }}">
              <input class="form-control" name="mpss_lookback" value="{{ promo.mpss_lookback }}">
              <input class="form-control" name="promo_grace" value="{{ promo.promo_grace }}">
              <input class="form-control" name="trade_in_grace" value="{{ promo.trade_in_grace }}">              <label class="section-label grid-full">Application Grace Period</label>
              <div class="input-group vertical-radio grid-full">
                {% for grace in ['G11','G12','G13','G14','G15','G16','G17','NULL'] %}
                  <label class="radio-vertical">
                    {{ grace }}
                    <input type="radio" name="application_grace_period" value="{{ grace }}" {% if promo.application_grace_period == grace %}checked{% endif %}>
                  </label>
                {% endfor %}
              </div>
            </div>
            <div class="save-footer">
              <button type="submit" class="btn btn-primary">Save Dates & Times</button>
            </div>

          {% elif active_tab == 'Requirements' %}            <div class="grid-form four-col">
              <label class="section-label">Device Sales Type</label>
              <label class="section-label">Activation Type</label>
              <label class="section-label">Active Line Required</label>
              <label class="section-label">Maintain SOC</label>
              <div class="input-group vertical-radio">
                {% for type in ['J01','S01','*','NULL'] %}
                  <label class="radio-vertical">
                    {{ type }}
                    <input type="radio" name="device_sales_type" value="{{ type }}" {% if promo.device_sales_type == type %}checked{% endif %}>
                  </label>
                {% endfor %}
              </div>
              <div class="input-group vertical-radio">
                {% for type in ['AE1','E01','N01','NA1','*','NULL'] %}
                  <label class="radio-vertical">
                    {{ type }}
                    <input type="radio" name="activation_type" value="{{ type }}" {% if promo.activation_type == type %}checked{% endif %}>
                  </label>
                {% endfor %}
              </div>
              <div class="input-group vertical-radio">
                <label class="radio-vertical">
                  Y
                  <input type="radio" name="active_line_required" value="Y" {% if promo.active_line_required == 'Y' %}checked{% endif %}>
                </label>
                <label class="radio-vertical">
                  N
                  <input type="radio" name="active_line_required" value="N" {% if promo.active_line_required == 'N' %}checked{% endif %}>
                </label>
              </div>
              <div class="input-group vertical-radio">
                <label class="radio-vertical">
                  Y
                  <input type="radio" name="maintain_soc" value="Y" {% if promo.maintain_soc == 'Y' %}checked{% endif %}>
                </label>
                <label class="radio-vertical">
                  N
                  <input type="radio" name="maintain_soc" value="N" {% if promo.maintain_soc == 'N' %}checked{% endif %}>
                </label>
              </div>

              <label class="section-label">Maintain Active Line</label>
              <label class="section-label">Limit Per BAN</label>
              <label class="section-label">Minimum GSM Count</label>
              <label class="section-label">Maximum GSM Count</label>
              <div class="input-group vertical-radio">
                <label class="radio-vertical">
                  Y
                  <input type="radio" name="maintain_active_line" value="Y" {% if promo.maintain_active_line == 'Y' %}checked{% endif %}>
                </label>
                <label class="radio-vertical">
                  N
                  <input type="radio" name="maintain_active_line" value="N" {% if promo.maintain_active_line == 'N' %}checked{% endif %}>
                </label>
              </div>              <input class="form-control" name="limit_per_ban" value="{{ promo.limit_per_ban }}">
              <input class="form-control" name="min_gsm_count" value="{{ promo.min_gsm_count }}">
              <input class="form-control" name="max_gsm_count" value="{{ promo.max_gsm_count if promo.max_gsm_count is not none else '' }}">

              <label class="section-label col-span-4">Port-In Group ID</label>
              <div class="input-group vertical-radio col-span-4">
                {% for group in ['G02','G03','G04','G05','G06','G07','NULL'] %}
                  <label class="radio-vertical">
                    {{ group }}
                    <input type="radio" name="port_in_group_id" value="{{ group }}" {% if promo.port_in_group_id == group %}checked{% endif %}>
                  </label>
                {% endfor %}
              </div><label class="section-label">Operator ID</label>
              <label class="section-label">SKU Group ID</label>
              <label class="section-label">Device Status Group ID</label>
              <label class="section-label">Clawback Indicator</label>
              <input class="form-control" name="operator_id" value="{{ promo.operator_id or '16085' }}">
              <input class="form-control" name="sku_group_id" value="{{ promo.sku_group_id }}">
              <input class="form-control" name="device_status_group_id" value="{{ promo.device_status_group_id }}">
              <div class="input-group vertical-radio">
                <label class="radio-vertical">
                  Y
                  <input type="radio" name="clawback_indicator" value="Y" {% if promo.clawback_indicator == 'Y' %}checked{% endif %}>
                </label>
                <label class="radio-vertical">
                  N
                  <input type="radio" name="clawback_indicator" value="N" {% if promo.clawback_indicator == 'N' %}checked{% endif %}>
                </label>
              </div>              <label class="section-label col-span-4">Flow Indicator</label>
              <div class="input-group vertical-radio col-span-4">
                {% for indicator in ['NULL','100RDC'] %}
                  <label class="radio-vertical">
                    {{ indicator }}
                    <input type="radio" name="flow_indicator" value="{{ indicator }}" {% if promo.flow_indicator == indicator %}checked{% endif %}>
                  </label>
                {% endfor %}
              </div>
            </div>
            <div class="save-footer">
              <button type="submit" class="btn btn-primary">Save Requirements</button>
            </div>

          {% elif active_tab == 'Segmentation' %}
            <div class="grid-form four-col">
              <label class="grid-full section-label">Segment Name</label>
              <input class="form-control grid-full mb-1" name="segment_name" value="{{ promo.segment_name }}">

              <label class="grid-full section-label">Sub Segment</label>
              <div class="input-group vertical-radio grid-full mb-1">
                {% for segment in ['Active Military','Family','Reserve','Retired','Promo Code'] %}
                  <label class="radio-vertical">
                    {{ segment }}
                    <input type="radio" name="sub_segment" value="{{ segment }}" {% if promo.sub_segment == segment %}checked{% endif %}>
                  </label>
                {% endfor %}
              </div>

              <label class="section-label col-span-2">Segment Group ID</label>
              <label class="section-label col-span-2">Segment Level</label>
              <input class="form-control col-span-2" name="segment_group_id" value="{{ promo.segment_group_id }}">              <div class="input-group vertical-radio col-span-2">
                {% for level in ['BAN','LINE','NA'] %}
                  <label class="radio-vertical">
                    {{ level }}
                    <input type="radio" name="segment_level" value="{{ level }}" {% if promo.segment_level == level %}checked{% endif %}>
                  </label>
                {% endfor %}
              </div>
            </div>
            <div class="save-footer">
              <button type="submit" class="btn btn-primary">Save Segmentation</button>
            </div>

          {% elif active_tab == 'Groupings' %}
            <div class="grid-form two-col">
              <label class="section-label center grid-full mb-2">SOC Grouping</label>
                <select class="form-select full-width" name="soc_grouping">
                  <option value="Group 1NS">Group 1NS</option>
                  <option value="Group 3">Group 3</option>
                  <option value="Group 4">Group 4</option>
                  <option value="Group 5">Group 5</option>
                  <option value="Group 6">Group 6</option>
                </select>
              <div class="details-box scrollable">
                <ul class="plain-list small-text">
                  <li class="bold mb-1">Group 1NS - GSM - Consumer & TFB</li>
                  <li class="mb-1">T-Mobile ONE rate plans</li>
                  <li class="mb-1">Magenta rate plans</li>
                  <li class="mb-1">Essentials rate plans</li>
                  <li class="mb-1">Bus/Gov Unlimited rate plans</li>
                  <li class="bold mb-1">Group 3 - MI - Consumer & TFB</li>
                  <li class="mb-1">10GB or higher Mobile Internet rate plans (limited buckets)</li>
                  <li class="mb-1">Excludes unlimited highspeed data plans</li>
                  <li class="bold mb-1">Group 4 - GSM - Consumer & TFB - excludes PlusUP & MAXUp line level upsell SOCs)</li>
                  <li class="bold mb-1">Group 5 - MI - All MTME Eligible MI/BTS - Consumer & TFB</li>
                  <li class="bold mb-1">Group 6 - GSM - Consumer & TFB</li>
                  <li class="mb-1">TMO ONE Plus rate plans (Incl. 55+)</li>
                  <li class="mb-1">Magenta Plus rate plans (Incl. First Responder & 55+)</li>
                  <li class="mb-1">Magenta MAX rate plans (Incl. First responder & 55+)</li>
                  <li class="mb-1">TMO ONE Plus Military rate plans</li>
                  <li class="mb-1">Magenta Plus Military rate plans</li>
                  <li class="mb-1">Magenta MAX Military rate plans</li>
                  <li class="mb-1">Business Unlimited Plus plans</li>
                  <li class="mb-1">Magenta Plus DHH plans</li>
                  <li class="mb-1">Magenta MAX DHH plans</li>
                  <li class="mb-1">Business Unlimited Ultimate plans</li>
                  <li class="mb-1">Plus Up Upsell SOCs (Include Intl/Global Plus SOCs)</li>
                  <li class="mb-1">MAXUp Upsell SOCs</li>
                  <li class="mb-1">Business Unlimited Upsell SOCs (Ultimate)</li>
                </ul>
              </div>
              <label class="section-label grid-full mt-1">Account Type</label>
              <div>
                <select class="form-select">
                  <option value="A01">A01</option>
                  <option value="A02">A02</option>
                  <option value="A03">A03</option>
                  <option value="A04">A04</option>
                  <option value="A05">A05</option>
                  <option value="A06">A06</option>
                  <option value="A07">A07</option>
                  <option value="A08">A08</option>
                  <option value="A09">A09</option>
                  <option value="A10">A10</option>
                </select>
              </div>
              <div class="details-box scrollable small-height">
                <ul class="plain-list">
                  <li class="mb-1">Regular (I/R); Association (I/A); GSA (I/F); Government (I/G); MCSA (I/M)</li>
                  <li class="mb-1">Corporate (B/C); Retail (B/L); MCSA (B/M); National (B/N); MCSAGE (B/O)</li>
                  <li class="mb-1">Non-Profit (B/P); Sole-Proprietorship (I/S)</li>
                  <li class="mb-1">Employee (S/Y); Non TMO Employee (S/6)</li>
                </ul>
              </div>
              <label class="section-label grid-full mt-1">Sales Applications</label>
              <div>
                <select class="form-select">
                  <option value="S01">S01</option>
                  <option value="S02">S02</option>
                  <option value="S03">S03</option>
                  <option value="S04">S04</option>
                  <option value="S05">S05</option>
                  <option value="S06">S06</option>
                  <option value="S07">S07</option>
                  <option value="S08">S08</option>
                  <option value="S09">S09</option>
                  <option value="S10">S10</option>
                </select>
              </div>
              <div class="details-box scrollable small-height">                <ul class="plain-list">
                  <li class="mb-1">Care - QVXPC; Dash (TSL) - Virtual Retail</li>
                  <li class="mb-1">QVXPR - Retail; POS - Retail; NAT - National Retail</li>
                  <li class="mb-1">Web (TMO) - T-Mo.com; Web - MyT-Mo (cloud)</li>
                  <li class="mb-1">Costco with EIP; BestBuy</li>
                </ul>
              </div>
            </div>
            <div class="save-footer">
              <button type="submit" class="btn btn-primary">Save Groupings</button>            </div>          {% elif active_tab == 'BPTCR' %}
            <div class="grid-form four-col">
              <label class="grid-full section-label">BPTCR</label>
              <input class="form-control grid-full mb-1" name="bptcr" value="{{ promo.bptcr or '' }}">
            </div>
            <div class="save-footer">
              <button type="submit" class="btn btn-primary">Save BPTCR</button>            </div>          {% elif active_tab == 'SQL Generation' %}
            <div class="grid-form two-col">
              <!-- SKU List Section -->
              <div class="col-span-1">
                <div class="upload-section">
                  <label class="section-label">SKU List (Excel)</label>
                  {% if promo.uploaded_files and promo.uploaded_files.get('sku_excel') %}
                    <div class="file-info-card">
                      <div class="file-info">
                        <i class="fas fa-file-excel"></i>
                        <div class="file-details">
                          <div class="file-name">{{ promo.uploaded_files.sku_excel.original_name }}</div>
                          <div class="file-meta">
                            {{ (promo.uploaded_files.sku_excel.file_size / 1024) | round(1) }} KB • 
                            {{ promo.uploaded_files.sku_excel.upload_date[:10] }}
                          </div>
                        </div>
                      </div>
                      <div class="file-actions">
                        <a href="{{ url_for('download_file', promo_code=promo.code, file_type='sku_excel') }}" 
                           class="btn btn-sm btn-outline">Download</a>
                      </div>
                    </div>
                  {% else %}
                    <div class="upload-area">
                      <input class="form-control" type="file" name="sku_excel" accept=".xlsx,.xls">
                      <small class="form-text">Upload Excel file with SKU list</small>
                    </div>
                  {% endif %}
                </div>
              </div>
                <!-- Trade-In List Section -->
              <div class="col-span-1">
                <div class="upload-section">
                  <label class="section-label">Trade-In List (Excel)</label>
                  {% if promo.uploaded_files and promo.uploaded_files.get('tradein_excel') %}
                    <div class="file-info-card">
                      <div class="file-info">
                        <i class="fas fa-file-excel"></i>
                        <div class="file-details">
                          <div class="file-name">{{ promo.uploaded_files.tradein_excel.original_name }}</div>
                          <div class="file-meta">
                            {{ (promo.uploaded_files.tradein_excel.file_size / 1024) | round(1) }} KB • 
                            {{ promo.uploaded_files.tradein_excel.upload_date[:10] }}
                          </div>
                        </div>
                      </div>
                      <div class="file-actions">
                        <a href="{{ url_for('download_file', promo_code=promo.code, file_type='tradein_excel') }}" 
                           class="btn btn-sm btn-outline">Download</a>
                      </div>
                    </div>
                  {% else %}
                    <div class="upload-area">
                      <input class="form-control" type="file" name="tradein_excel" accept=".xlsx,.xls">
                      <small class="form-text">Upload Excel file with trade-in list</small>
                    </div>
                  {% endif %}
                </div>
              </div>
            </div>
              <!-- Display Generated SQL -->
            {% if promo.generated_sql %}
            <div class="grid-form one-col" style="margin-top: 2rem;">
              <label class="section-label">Generated SQL Statement</label>
              <div class="file-info-card" style="margin-bottom: 1rem;">
                <div class="file-info">
                  <i class="fas fa-database"></i>
                  <div>
                    <div class="file-name">{{ promo.sql_file.filename if promo.sql_file else promo.code + '_promo_eligibility_rules.sql' }}</div>
                    <div class="file-meta">
                      Generated on {{ promo.sql_file.generated_at if promo.sql_file else 'Unknown' }}
                    </div>
                  </div>
                </div>
                <div class="file-actions">
                  <a href="{{ url_for('download_sql', promo_code=promo.code) }}" 
                     class="btn btn-sm btn-outline">
                    <i class="fas fa-download"></i> Download SQL
                  </a>
                </div>
              </div>
              <textarea class="form-control" rows="8" readonly style="font-family: monospace; font-size: 12px; background-color: #f8f9fa;">{{ promo.generated_sql }}</textarea>
              <small class="form-text">SQL file has been generated and saved. Use the download button above to get the file.</small>
            </div>
            {% endif %}
            
            <div class="save-footer">
              <button type="submit" class="btn btn-primary">Save SQL Generation</button>
              <button type="submit" name="generate_sql" value="1" class="btn btn-secondary" style="margin-left:1em;">
                <i class="fas fa-cog"></i> Generate SQL
              </button>
            </div>
          {% endif %}

        </form>
      </div>
    </div>
  </div>
{% endblock %}
